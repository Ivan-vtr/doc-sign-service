{% extends "web/base.html" %}
{% block title %}{{ document.title }} - DocSign{% endblock %}
{% block nav_docs %}active{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'web-dashboard' %}">Документы</a></li>
        <li class="breadcrumb-item active">{{ document.title }}</li>
    </ol>
</nav>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0" style="font-weight:700;font-size:1.15rem">{{ document.title }}</h4>
        <span class="status-badge status-{{ document.status.value }}">{{ document.status.value }}</span>
    </div>
    <div class="card-body">
        <div class="info-grid">
            <div class="info-label">Имя файла</div>
            <div class="info-value">{{ document.filename }}</div>
            <div class="info-label">Тип</div>
            <div class="info-value">{{ document.mime_type }}</div>
            <div class="info-label">Размер</div>
            <div class="info-value"><span class="file-size" data-bytes="{{ document.file_size }}">{{ document.file_size }} Б</span></div>
            <div class="info-label">SHA-256</div>
            <div class="info-value"><code>{{ document.sha256 }}</code></div>
            {% if document.sigex_document_id %}
            <div class="info-label">Sigex ID</div>
            <div class="info-value"><code>{{ document.sigex_document_id }}</code></div>
            {% endif %}
            <div class="info-label">Создан</div>
            <div class="info-value">{{ document.created_at }}</div>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex gap-2 flex-wrap">
            <a href="/api/documents/{{ document.id }}/download/" class="btn-action">Скачать оригинал</a>
            {% if document.signed_file_path %}
            <a href="/api/documents/{{ document.id }}/download-signed/" class="btn-action btn-action-success">Скачать подписанный</a>
            {% endif %}
            {% if document.status.value == "uploaded" or document.status.value == "registered" %}
            <a href="{% url 'web-signing' document.id %}" class="btn-action btn-action-success">Подписать документ</a>
            {% endif %}
            {% if document.status.value == "signed" %}
            <button class="btn-action" id="verify-btn" onclick="verifyDocument()">Проверить подписи</button>
            {% endif %}
        </div>
    </div>
</div>

{% if status_result.signatures %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0" style="font-weight:600;font-size:1rem">Подписи</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-clean mb-0">
                <thead>
                    <tr>
                        <th>Подписант</th>
                        <th>ИИН</th>
                        <th>Тип</th>
                        <th>Статус</th>
                        <th>Дата подписания</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sig in status_result.signatures %}
                    <tr>
                        <td style="font-weight:500">{{ sig.signer_name }}</td>
                        <td><code style="font-size:.78rem;background:#f3f4f6;padding:.15em .4em;border-radius:4px">{{ sig.signer_iin }}</code></td>
                        <td>{{ sig.signer_type }}</td>
                        <td><span class="status-badge status-{{ sig.status }}">{{ sig.status }}</span></td>
                        <td style="color:var(--text-secondary)">{{ sig.signed_at|default:"\u2014" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div id="verify-result" class="mt-3"></div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.file-size').forEach(function(el) {
    el.textContent = formatFileSize(parseInt(el.dataset.bytes));
});

async function verifyDocument() {
    var btn = document.getElementById('verify-btn');
    var resultDiv = document.getElementById('verify-result');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Проверка...';

    try {
        var result = await apiFetch('/api/documents/{{ document.id }}/verify/', {
            method: 'POST',
            body: JSON.stringify({})
        });

        var ok = result.verified;
        resultDiv.innerHTML =
            '<div class="alert alert-' + (ok ? 'success' : 'danger') + '">' +
            '<span class="' + (ok ? 'verify-ok' : 'verify-fail') + '">' + (ok ? '\u2713' : '\u2717') + '</span> ' +
            '<strong>' + (ok ? 'Документ успешно проверен' : 'Проверка не пройдена') + '</strong><br>' +
            '<span style="font-size:.85rem">' +
            'Контрольная сумма: ' + (result.checksum_match ? '\u2713 Совпадает' : '\u2717 Не совпадает') + ' &middot; ' +
            'Sigex: ' + (result.sigex_verified ? '\u2713 Проверен' : '\u2717 Не проверен') +
            '</span></div>';
    } catch (e) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Ошибка проверки: ' + e.message + '</div>';
    }

    btn.disabled = false;
    btn.textContent = 'Проверить подписи';
}
</script>
{% endblock %}
